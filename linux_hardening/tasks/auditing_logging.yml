---
- name: Ensure auditd service enabled
  service:
    name: auditd
    enabled: yes
    state: started

- name: Configure auditd max_log_file
  lineinfile:
    path: /etc/audit/auditd.conf
    regexp: '^max_log_file\s*='
    line: 'max_log_file = {{ audit_max_log_file }}'
    create: yes
  notify: restart auditd

- name: Configure auditd space_left_action, action_mail_acct, admin_space_left_action
  replace:
    path: /etc/audit/auditd.conf
    regexp: '^space_left_action\s*=.*'
    replace: 'space_left_action = email'
  ignore_errors: yes

- name: Ensure max_log_file_action set to keep_logs
  lineinfile:
    path: /etc/audit/auditd.conf
    regexp: '^max_log_file_action\s*='
    line: 'max_log_file_action = keep_logs'
    create: yes
  notify: restart auditd

- name: Add audit rules for important events (64-bit)
  blockinfile:
    path: /etc/audit/audit.rules
    block: |
      -a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time-change
      -a always,exit -F arch=b32 -S adjtimex -S settimeofday -S stime -k time-change
      -w /etc/localtime -p wa -k time-change

      -w /etc/group -p wa -k identity
      -w /etc/passwd -p wa -k identity
      -w /etc/gshadow -p wa -k identity
      -w /etc/shadow -p wa -k identity
      -w /etc/security/opasswd -p wa -k identity

      -w /etc/issue -p wa -k system-locale
      -w /etc/issue.net -p wa -k system-locale
      -w /etc/hosts -p wa -k system-locale
      -w /etc/sysconfig/network -p wa -k system-locale

      -w /var/log/faillog -p wa -k logins
      -w /var/log/lastlog -p wa -k logins
      -w /var/log/tallylog -p wa -k logins

      -w /var/run/utmp -p wa -k session
      -w /var/log/wtmp -p wa -k session
      -w /var/log/btmp -p wa -k session

      -a always,exit -F arch=b64 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EACCES -F auid>=500 -F auid!=4294967295 -k access
      -a always,exit -F arch=b64 -S unlink -S unlinkat -S rename -S renameat -F auid>=500 -F auid!=4294967295 -k delete

      -w /etc/sudoers -p wa -k scope
      -w /etc/sudoers.d -p wa -k scope
      -w /var/log/sudo.log -p wa -k actions

      -e 2
  notify: restart auditd

- name: Ensure authpriv logs go to /var/log/secure
  lineinfile:
    path: /etc/rsyslog.conf
    regexp: '^authpriv\.'
    line: 'authpriv.*    /var/log/secure'
    create: yes
  notify: restart rsyslog

- name: Ensure /var/log/secure exists
  file:
    path: /var/log/secure
    state: touch
    owner: root
    group: root
    mode: '0600'

